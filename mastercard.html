<!DOCTYPE html>
<html>
  <head>
    <title>Authenticate or Create Passkey</title>
    <script src="http://fahadsaleem99.github.io/passkeydemo/cbor.js" type="text/javascript"></script>
    <script>
      function arrayBufferToString(input) {
  	return String.fromCharCode(...new Uint8Array(input));
  	}
  
  function arrayBufferToBase64(input) {
  	return btoa(arrayBufferToString(input));
  	}
    	
    	
    	function toHexString(byteArray) {
    		return Array.from(byteArray, function(byte) {
    			return ('0' + (byte & 0xFF).toString(16)).slice(-2);
    			}).join('')
    			}
    	
    	function buf2hex(buffer) { // buffer is an ArrayBuffer
    		return [...new Uint8Array(buffer)]
    		.map(x => x.toString(16).padStart(2, '0'))
    		.join('');
    		}
    	
    	function ab2str(buf) {
    		return String.fromCharCode.apply(null, new Uint8Array(buf));
    		}
    	
    	function base64ToArray(input) {
    		return Uint8Array.from(atob(input), c => c.charCodeAt(0))
    		}
      
      async function authenticate() {
			
			//console.log(passedCredNew);
			
			// To abort a WebAuthn call, instantiate an `AbortController`.  
			try {
				
			
			const abortController = new AbortController();
			
			const publicKeyCredentialRequestOptions = {  
				// Server generated challenge  
				challenge: Uint8Array.from("4A54657686543D3CABCD", c => c.charCodeAt(0)),
				
				//allowCredentials: [{
				//use NORMAL base64 data NOT the url-safe base64 data generated by key creation response
				//id:	base64ToArray("AYvbMGEYKYlh+eoC5aqmmV5vvc1vCFoyonKDmo/uYynvV9kAnD/1DlWNa44S1Y6uzcHZIFLReDK3RRy3Ls27+8A="),
        //type: 'public-key',
        //transports: ['internal'],
    //}],
				
				// The same RP ID as used during registration  
				//rpId: 'localhost',
				rpId: 'fahadsaleem99.github.io',
				//rpId: '192.168.86.250',  
				userVerification: "required",
				};
				
			const credential = await navigator.credentials.get({  
				publicKey: publicKeyCredentialRequestOptions,  
				//signal: abortController.signal,  
				// Specify 'conditional' to activate conditional UI  
				//mediation: 'conditional'
				});
				
			console.log(credential);
			console.log("response id: " + credential.id);
			var rawIdentity = new Uint8Array(credential.rawId);
			const rawIdData = buf2hex(rawIdentity);
			console.log("Raw Identity: " + rawIdData);
			
			const utf8Decoder = new TextDecoder('utf-8');
			const decodedClientData = utf8Decoder.decode(credential.response.clientDataJSON);
			// parse the string as an object
			const clientDataObj = JSON.parse(decodedClientData);
			var str = JSON.stringify(clientDataObj, null, 4);
			console.log("Decoded Client Data JSON:" + str);
			
			//console.log(credential.response.authenticatorData);
			
			var authDataAssertion = new Uint8Array(credential.response.authenticatorData);
			//console.log(authDataAssertion);
			const authDataAssert = buf2hex(authDataAssertion)
			console.log("Auth Data from AssertionHex: " + authDataAssert)
			//console.log(buf2hex(authDataAssertion));
			
			var signatureAssertion = new Uint8Array(credential.response.signature);
			//console.log(uint8View);
			const sigAssertion = buf2hex(signatureAssertion)
			console.log("Assertion Signature Hex: " + sigAssertion)
			//console.log(buf2hex(signatureAssertion));
			
			var userHandleResponse = new Uint8Array(credential.response.userHandle);
			//console.log(uint8View);
			const userHandle = buf2hex(userHandleResponse)
			console.log("User Handle Hex: " + userHandle)
			//console.log(buf2hex(userHandleResponse));
			
			//var auth_data = new Uint8Array(attestation.response.authenticatorData);
			let data_hash = new Uint8Array(await crypto.subtle.digest('SHA-256', credential.response.clientDataJSON));
			//var data_hash = sha256(new Uint8Array(credential.response.clientDataJSON));
			var signed    = new Uint8Array(authDataAssertion.length + data_hash.length);
			
			//Uint8Array.set(Uint8Array[data, offset])
			signed.set(authDataAssertion);
			signed.set(data_hash, authDataAssertion.length);
			
			const dataString = buf2hex(signed)
			console.log("Data string for signature verification in hex: " + dataString)
			//console.log(buf2hex(signed));
			window.location.assign("success.html");
		} catch (err) {
          console.warn("Authentication failed:", err);
          document.getElementById("createButton").style.display = "block";
        }

			
		}

      function arrayBufferToBase64(input) {
  	return btoa(arrayBufferToString(input));
  	}
  	
  	function arrayBufferToString(input) {
  	return String.fromCharCode(...new Uint8Array(input));
  	}
		async function createPasskey() {
			//alert("I've been clicked!!");
			
			var x = "fahad";
			//console.log(x);
			const genRanHex = size => [...Array(size)].map(() => Math.floor(Math.random() * 16).toString(16)).join('');
			const useridentity = genRanHex(32);
			const challengeCreate = genRanHex(32);
			
			const fahad = Uint8Array.from("UZSL85T9AFC", c => c.charCodeAt(0));
			
			console.log("Random User ID:" + useridentity);
			console.log("Random Challenge: " + challengeCreate);
			
			const publicKeyCredentialCreationOptions = { 
				publicKey:{
				challenge: Uint8Array.from(challengeCreate, c => c.charCodeAt(0)),
				rp: {  
				name: "Click to Pay Demo",  
				id: "fahadsaleem99.github.io",
				//id: "localhost",  
				},
				user: {  
				id: Uint8Array.from("UZSL85T9AFC", c => c.charCodeAt(0)),
				//id: Uint8Array.from(useridentity, c => c.charCodeAt(0)),
				name: x,  
				displayName: x,
				},
				pubKeyCredParams: [{alg: -7, type: "public-key"},{alg: -257, type: "public-key"}],  
				//excludeCredentials: [{  
				//id: Uint8Array.from("1234", c => c.charCodeAt(0)), 
				//type: 'public-key',  
				//transports: ['internal'],
				//}],
				attestation: "direct",
				authenticatorSelection: {  
				authenticatorAttachment: "platform",  
				requireResidentKey: true,
				userVerification: "required",
				}
				}
			};
			//const credential = await navigator.credentials.create({  
			//publicKey: publicKeyCredentialCreationOptions
			//});
			
			navigator.credentials.create(publicKeyCredentialCreationOptions).then(function (credential) {
			
			console.log(credential);
			
			//Get Identity generated
			const identity = credential.id;
			console.log("Identity Base64: " + identity);
			

			
			//Get Raw ID
			var rawIdentity = new Uint8Array(credential.rawId);
			const rawIdData = buf2hex(rawIdentity);
			console.log("Raw Identity: " + rawIdData);
			
			window.localStorage.setItem("windowLocalStorageIdentifier", arrayBufferToBase64(credential.rawId));
			console.log("Item stored in cache: " + arrayBufferToBase64(credential.rawId));
			
			
			// decode the clientDataJSON into a utf-8 string
			const utf8Decoder = new TextDecoder('utf-8');
			const decodedClientData = utf8Decoder.decode(credential.response.clientDataJSON);
			// parse the string as an object
			const clientDataObj = JSON.parse(decodedClientData);
			var str = JSON.stringify(clientDataObj, null, 4);
			console.log("Decoded Client Data JSON:" + str);
			
			//Get Transport
			const transports = credential.response.getTransports();
			console.log("Transports:" + transports);
			
			//Get Public Key
			const getpkey = credential.response.getPublicKey();
			var pkeyAtt = new Uint8Array(getpkey);
			const pkeyAttDec = buf2hex(pkeyAtt);
			console.log("Public Key: " + pkeyAttDec);
			
			//Get Authenticator Data
			const getAD = credential.response.getAuthenticatorData();
			var getADArr = new Uint8Array(getAD);
			const getADDec = buf2hex(getADArr);
			console.log("Authenticator Data: " + getADDec);
			
			//Get Public Key Algorithm
			const getAlgo = credential.response.getPublicKeyAlgorithm();
			console.log("Public Key Algorithm : " + getAlgo);
			
			//CBOR
			const decodedAttestationObject = CBOR.decode(credential.response.attestationObject);
			console.log("Decoded Attestation Object:");
			console.log(decodedAttestationObject);
			
			console.log("Attestation Object Format: " + decodedAttestationObject.fmt);
			
			const attStatement = decodedAttestationObject.attStmt
			console.log("Attestation Algorithm: " + attStatement.alg);
			
			//console.log("Attestation Signature: " + attStatement.sig);
			var attSignature = new Uint8Array(attStatement.sig);
			const attSig = buf2hex(attSignature);
			console.log("Attestation Signature: " + attSig);
			
			
			//console.log("Auth Data: " + decodedAttestationObject.authData);
			var authDataRaw = new Uint8Array(decodedAttestationObject.authData);
			const authDataNew = buf2hex(authDataRaw);
			console.log("Auth Data Hex Self decode: " + authDataNew);
			
			
			
			
			const {authData} = decodedAttestationObject;
			// get the length of the credential ID
			const dataView = new DataView(new ArrayBuffer(2));
			const idLenBytes = authData.slice(53, 55);
			idLenBytes.forEach(
			(value, index) => dataView.setUint8(
			index, value));
			const credentialIdLength = dataView.getUint16();
			
			// get the credential ID
			const credentialId = authData.slice(55, 55 + credentialIdLength);
			//console.log("Credential ID: " + credentialId);
			const credId = toHexString(credentialId);
			console.log("Credential ID HEX: " + credId);

			
			//store in local storage for test
			//localStorage.setItem('credid', `${hexCredId}`);
			//localStorage.setItem('credid', hexCredId);
			
			// get the public key object
			const publicKeyBytes = authData.slice(55 + credentialIdLength);
			
			// the publicKeyBytes are encoded again as CBOR
			const publicKeyObject = CBOR.decode(publicKeyBytes.buffer);
			//console.log("Public Key Object:");
			//console.log(publicKeyObject);
			
			console.log("Public Key x-coordinate:");
			//console.log(publicKeyObject['-2']);
			const publickeyx = publicKeyObject['-2'];
			console.log(buf2hex(publickeyx));
			
			console.log("Public Key y-coordinate:");
			//console.log(publicKeyObject['-3']);
			const publickeyy = publicKeyObject['-3'];
			console.log(buf2hex(publickeyy));
			
		})
			
		}

      window.addEventListener('load', authenticate);
    </script>
    <style>
      #createButton {
        display: none;
        margin-top: 20px;
      }
    </style>
  </head>
  <body>
    <h1>Authenticating...</h1>
    <button id="createButton" onclick="createPasskey()">Create Passkey</button>
  </body>
</html>
