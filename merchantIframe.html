<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mock Checkout - MyStore</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 600px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 30px;
        }

        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 28px;
        }

        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }

        .product-section {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .product-item {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }

        .product-image {
            width: 80px;
            height: 80px;
            background: #f0f0f0;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
        }

        .product-details {
            flex: 1;
        }

        .product-name {
            font-weight: 600;
            color: #333;
            margin-bottom: 5px;
        }

        .product-price {
            color: #666;
            font-size: 18px;
            font-weight: 700;
        }

        .total-section {
            border-top: 2px solid #e0e0e0;
            padding-top: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 20px;
            font-weight: 700;
        }

        .btn-buy {
            width: 100%;
            padding: 16px;
            background: #00112c;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s ease;
            margin-top: 20px;
        }

        .btn-buy:hover {
            background: #1c3045;
        }

        .btn-buy:active {
            background: #3a4a5c;
        }

        .btn-buy:disabled {
            background: #ccc;
            cursor: not-allowed;
        }

        .status-message {
            padding: 12px;
            border-radius: 6px;
            margin-top: 15px;
            font-size: 14px;
            display: none;
        }

        .status-message.show {
            display: block;
        }

        .status-message.info {
            background: #e5f1ff;
            color: #0066cc;
            border: 1px solid #b3d9ff;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        #passkeyIframe {
            display: none;
            width: 0;
            height: 0;
            border: none;
        }

        .loading-spinner {
            display: inline-block;
            width: 14px;
            height: 14px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 0.8s linear infinite;
            margin-left: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        #display {
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Checkout</h1>
        <p class="subtitle">Complete your purchase</p>

        <div class="product-section">
            <div class="product-item">
                <div class="product-image">üëï</div>
                <div class="product-details">
                    <div class="product-name">Premium Polo Shirt</div>
                    <div class="product-price">$36.39</div>
                </div>
            </div>

            <div class="total-section">
                <span>Total:</span>
                <span>$36.39 USD</span>
            </div>
        </div>

        <button id="buyButton" class="btn-buy">Complete Purchase</button>

        <button id="buyButton2" class="btn-buy">Complete Purchase (New Window)</button>

        

        <div id="statusMessage" class="status-message"></div>

        <!-- Hidden iframe for passkey check -->
        <iframe id="passkeyIframe" src="" allow="publickey-credentials-get; publickey-credentials-create"></iframe>

        <!-- Display area for Mastercard auth iframe -->
        <div id="display"></div>
    </div>

    <script>
    	//<button onclick="createPasskey()">Create Passkey</button>
    	//<button onclick="verifyPasskey()">Log in with a Passkey</button>
    	
    	async function openWin() {
    		//window.open("https://sandbox.src.mastercard.com/auth/?origin=http://localhost:9000", "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,top=350,left=600,width=600,height=600");
    		
    		var myWindow = window.open("", "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,top=200,left=600,width=500,height=700");
    		
    		//let myWindow = window.open("", "_blank", "toolbar=yes,scrollbars=yes,resizable=yes,top=350,left=600,width=600,height=600");

    		//const view1 = document.defaultView;
    		//console.log("THIS IS: ");
    		//console.log(view1);
    		//console.log(window.self);
    		
    		myWindow.location.href = `https://sandbox.src.mastercard.com/auth?origin=${window.location.origin}`;
    		
    		var srcserviceid = 'SECURE_COF_COMMERCE_PLATFORM#DOCUMENTATION-UPN2#01';
    		var srcclientid = '5e0d4b84-189d-4c86-822d-590602f62062';
    		
    		var digcardid = 'S5bWtnSbRUGezq0g7HJXjw000000000000US';
            var correlationid = 'abf67404-85e2-4186-a057-7eaeb0ecac87';
    		
    		//var digcardid = '3el7a-XTSDOl1WQLLBhSEw000000000000US';
    		//var correlationid = '307a74be-0df5-4c2f-8252-6d0bd7f6639d';
    		//var authreason = 'ENROL_FINANCIAL_INSTRUMENT';
    		var authreason = 'TRANSACTION_AUTHENTICATION';
    		var authmethod = 'MANAGED_AUTHENTICATION';
    		var txamt = '36.39';
    		var txcode = 'USD';
    		
    		
    		//let text = '{"authenticationContext":{"srciDpaId":"5e0d4b84-189d-4c86-822d-590602f62062_SCOF","dpaTransactionOptions":{"transactionAmount":{"transactionAmount":36.49,"transactionCurrencyCode":"USD"}},"authenticationReasons":["ENROL_FINANCIAL_INSTRUMENT"]},"authenticationMethod":{"authenticationMethodType":"3DS","authenticationSubject":"CARDHOLDER","uriData":{"uri":"https://sandbox.src.mastercard.com/auth","uriType":"WEB_URI"}},"srcCorrelationId":"78813171-eb16-4878-8a1a-b0fa0013345e","accountReference":{"srcDigitalCardId":"79765757-5d92-40a8-bbe0-e4d8f7d2e3d6"},"serviceId":"SECURE_COF_COMMERCE_PLATFORM#DOCUMENTATION-UPN2#01","srcClientId":"5e0d4b84-189d-4c86-822d-590602f62062"}';
    		
    		//Working MFA New
    		//let text = '{"authenticationContext":{"dpaTransactionOptions":{"transactionAmount":{"transactionAmount":36.49,"transactionCurrencyCode":"USD"}},"authenticationReasons":["ENROL_FINANCIAL_INSTRUMENT"]},"authenticationMethod":{"authenticationMethodType":"3DS","authenticationSubject":"CARDHOLDER","uriData":{"uri":"https://sandbox.src.mastercard.com/auth","uriType":"WEB_URI"}},"srcCorrelationId":"65d5cb33-3105-4ccb-84e9-f01a82291459","accountReference":{"srcDigitalCardId":"53c40e2b-59d2-449d-b064-f57da9f2a07a"},"serviceId":"SECURE_COF_COMMERCE_PLATFORM#DOCUMENTATION-UPN2#01","srcClientId":"5e0d4b84-189d-4c86-822d-590602f62062"}';
    		
    		//Autofill Test
    		//let text = '{"authenticationContext":{"dpaTransactionOptions":{"transactionAmount":{"transactionAmount":0,"transactionCurrencyCode":"USD"}},"authenticationReasons":["ENROL_FINANCIAL_INSTRUMENT"]},"authenticationMethod":{"authenticationMethodType":"3DS","authenticationSubject":"CARDHOLDER","uriData":{"uri":"https://sandbox.src.mastercard.com/auth","uriType":"WEB_URI"}},"srcCorrelationId":"81a3bf9c-de9b-4d4a-abe7-92f85818598e","accountReference":{"srcDigitalCardId":"013ce9c8-6cca-469e-b35b-8cf405128930"},"serviceId":"AUTOFILL#Mobegic_Autofill#01","srcClientId":"6ce233b9-ad52-4e96-8448-87f8773c6b60"}';
    		
    		
    		//Testing TAS FIDO enrollment
    		//let text = '{"srcCorrelationId":"a03b220d-e71e-44aa-9315-bfe27ade1608","serviceId":"SECURE_COF_COMMERCE_PLATFORM#DOCUMENTATION-UPN2#01","srcClientId":"5e0d4b84-189d-4c86-822d-590602f62062","accountReference":{"srcDigitalCardId":"xhVa3tasR22GSDH2Rl7Djg000000000000US"},"authenticationMethod":{"authenticationMethodType":"MANAGED_AUTHENTICATION"},"authenticationContext":{"authenticationReasons":["TRANSACTION_AUTHENTICATION"],"acquirerMerchantId":"550e8400","acquirerBIN":"444444","dpaTransactionOptions":{"transactionAmount":{"transactionAmount":36.49,"transactionCurrencyCode":"USD"}}}}';
    		//let text = '{"authenticationContext":{"dpaTransactionOptions":{"transactionAmount":{"transactionAmount":36.49,"transactionCurrencyCode":"USD"}},"authenticationReasons":["ENROL_FINANCIAL_INSTRUMENT"]},"authenticationMethod":{"authenticationMethodType":"3DS","authenticationSubject":"CARDHOLDER","uriData":{"uri":"https://sandbox.src.mastercard.com/auth","uriType":"WEB_URI"}},"srcCorrelationId":"65d5cb33-3105-4ccb-84e9-f01a82291459","accountReference":{"srcDigitalCardId":"53c40e2b-59d2-449d-b064-f57da9f2a07a"},"serviceId":"SECURE_COF_COMMERCE_PLATFORM#DOCUMENTATION-UPN2#01","srcClientId":"5e0d4b84-189d-4c86-822d-590602f62062"}';
    		let text = '{"authenticationContext":{"dpaTransactionOptions":{"transactionAmount":{"transactionAmount":'+txamt+',"transactionCurrencyCode":"'+txcode+'"}},"authenticationReasons":["'+authreason+'"]},"authenticationMethod":{"authenticationMethodType":"'+authmethod+'","authenticationSubject":"CARDHOLDER"},"srcCorrelationId":"'+correlationid+'","accountReference":{"srcDigitalCardId":"'+digcardid+'"},"serviceId":"'+srcserviceid+'","srcClientId":"'+srcclientid+'"}';
    		

const payload = JSON.parse(text);
    		
    		return new Promise((resolve, reject) => {
    		window.addEventListener("message", (event) => {
  // Do we trust the sender of this message?
  if (event.origin !== "https://sandbox.src.mastercard.com") 
  	{console.log('This is not what I want');
  		return;}
    		//window.addEventListener('message', ({ data, source, origin }) => {
          console.log('Source::', event.source);
          console.log('data::', event.data);
          console.log('Origin::', event.origin);
          switch (event.data.action) {
            case 'Ready':
              //return window.postMessage({
              console.log('I sent this::', payload);
              
              return event.source.postMessage({	
                action: 'Authenticate',
                payload},event.origin)
                
                
            case 'Success':
              console.log('3DS Successfully completed')
              myWindow.close();
              return resolve(payload)
            case 'Error':
              console.log('3DS Error')
              myWindow.close();
              return reject(payload)
          }
        })
    		
    		})
    	}
    </script>

    <script>
        const buyButton = document.getElementById('buyButton');
        const buyButton2 = document.getElementById('buyButton2');
        const statusMessage = document.getElementById('statusMessage');
        const passkeyIframe = document.getElementById('passkeyIframe');
        const displayDiv = document.getElementById('display');

        let passkeySupported = false;

        // Function to show status message
        function showStatus(message, type) {
            statusMessage.textContent = message;
            statusMessage.className = `status-message show ${type}`;
        }

        // Function to hide status message
        function hideStatus() {
            statusMessage.className = 'status-message';
        }

        // Listen for messages from iframePK.html
        window.addEventListener('message', (event) => {
            // Handle passkey support check response
            if (event.data.type === 'passkey-support') {
                console.log('Passkey support check result:', event.data);
                
                if (event.data.supported && event.data.platformAuthenticator) {
                    passkeySupported = true;
                    showStatus('‚úÖ Passkey authentication available on this device', 'success');
                    console.log('Device supports passkeys - proceeding with authentication');
                    
                    // Now trigger the Mastercard authentication flow
                    setTimeout(() => {
                        launchiframe();
                    }, 1000);
                } else {
                    passkeySupported = false;
                    showStatus('‚ö†Ô∏è Passkeys not available. Using alternative authentication.', 'info');
                    console.log('Passkeys not supported - falling back to 3DS');
                    
                    // Fallback to standard 3DS flow
                    setTimeout(() => {
                        openWin();
                    }, 1000);
                }
            }

            // Handle Mastercard authentication messages
            if (event.origin === "https://sandbox.src.mastercard.com") {
                console.log('Mastercard message received:', event.data);
                // Handle authentication flow here
            }
        });

        // Buy button click handler
        buyButton.addEventListener('click', async () => {
            buyButton.disabled = true;
            buyButton.innerHTML = 'Processing<span class="loading-spinner"></span>';
            hideStatus();

            showStatus('üîç Checking device capabilities...', 'info');

            // Load the passkey check iframe
            passkeyIframe.src = 'iframePK.html';
            
            // The iframe will automatically check and send back results via postMessage
        });

        buyButton2.addEventListener('click', () => {
    openWin();               
  });

        // Mastercard authentication flow
        async function launchiframe() {
            showStatus('üîê Initializing secure authentication...', 'info');

            // Creating iframe element
            let myWindow = document.createElement("iframe");

            // Setting the values for the attributes
            myWindow.src = "https://sandbox.src.mastercard.com/auth?origin=https://fahadsaleem99.github.io";
            myWindow.allow = "payment; publickey-credentials-create; publickey-credentials-get"; 
            myWindow.width = "400px";
            myWindow.height = "300px";
            myWindow.style.border = "1px solid #e0e0e0";
            myWindow.style.borderRadius = "8px";
            myWindow.style.marginTop = "20px";

            // Adding the created iframe to div as a child element
            displayDiv.appendChild(myWindow);

            // Authentication parameters
            var srcserviceid = 'SECURE_COF_COMMERCE_PLATFORM#DOCUMENTATION-UPN2#01';
            var srcclientid = '5e0d4b84-189d-4c86-822d-590602f62062';
            var digcardid = 'S5bWtnSbRUGezq0g7HJXjw000000000000US';
            var correlationid = 'abf67404-85e2-4186-a057-7eaeb0ecac87';
            var authreason = 'TRANSACTION_AUTHENTICATION';
            var authmethod = passkeySupported ? 'MANAGED_AUTHENTICATION' : '3DS';
            var txamt = '36.39';
            var txcode = 'USD';

            let text = `{"authenticationContext":{"acquirerBIN": "444444","acquirerMerchantId": "550e8400","dpaData":{"dpaName":"Sample_DPA","dpaUri":"www.samplewebsite.com"},"dpaTransactionOptions":{"merchantCategoryCode":"0008","merchantCountryCode":"US","transactionAmount":{"transactionAmount":${txamt},"transactionCurrencyCode":"${txcode}"}},"authenticationReasons":["${authreason}"]},"authenticationMethod":{"authenticationMethodType":"${authmethod}","authenticationSubject":"CARDHOLDER"},"srcCorrelationId":"${correlationid}","accountReference":{"srcDigitalCardId":"${digcardid}"},"serviceId":"${srcserviceid}","srcClientId":"${srcclientid}"}`;

            const payload = JSON.parse(text);

            return new Promise((resolve, reject) => {
                window.addEventListener("message", (event) => {
                    // Verify sender origin
                    if (event.origin !== "https://sandbox.src.mastercard.com") {
                        console.log('Ignoring message from untrusted origin');
                        return;
                    }

                    console.log('Authentication event:', event.data);

                    switch (event.data.action) {
                        case 'Ready':
                            console.log('Mastercard auth ready - sending payload:', payload);
                            showStatus('üì§ Sending authentication request...', 'info');
                            
                            return myWindow.contentWindow.postMessage({
                                action: 'Authenticate',
                                payload
                            }, event.origin);

                        case 'Success':
                            console.log('Authentication successful!');
                            showStatus('‚úÖ Payment authenticated successfully!', 'success');
                            displayDiv.removeChild(displayDiv.lastChild);
                            buyButton.disabled = false;
                            buyButton.innerHTML = 'Complete Purchase';
                            return resolve(payload);

                        case 'Error':
                            console.log('Authentication error');
                            showStatus('‚ùå Authentication failed. Please try again.', 'error');
                            displayDiv.removeChild(displayDiv.lastChild);
                            buyButton.disabled = false;
                            buyButton.innerHTML = 'Complete Purchase';
                            return reject(payload);
                    }
                });
            });
        }
    </script>
</body>
</html>
